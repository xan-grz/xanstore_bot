<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–ú–∞–≥–∞–∑–∏–Ω –≤ Telegram</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg: #ffffff;
      --text: #222222;
      --card: #f5f5f5;
      --accent: #0088cc;
      --muted: #777777;
    }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg); color: var(--text);
    }
    header{
      position: sticky; top:0; z-index:10; background: var(--bg);
      padding: 16px; border-bottom: 1px solid #e6e6e6;
      display:flex; align-items:center; justify-content:space-between;
    }
    .title{ font-size:18px; font-weight:600; }
    .grid{
      display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; padding:12px;
    }
    .card{
      background: var(--card); border-radius:12px; overflow:hidden; display:flex; flex-direction:column;
      border:1px solid #e9e9e9;
    }
    .card img{ width:100%; height:120px; object-fit:cover; display:block; }
    .card .pad{ padding:10px; display:flex; flex-direction:column; gap:6px; }
    .name{ font-weight:600; font-size:14px; line-height:1.2; }
    .price{ font-weight:700; }
    .muted{ color: var(--muted); font-size:12px; }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .qty{
      display:flex; align-items:center; gap:8px;
    }
    button{
      border:none; padding:8px 10px; border-radius:10px; font-weight:600; font-size:14px;
      background: var(--accent); color:#fff;
    }
    .btn-ghost{ background:#e9f4fb; color:#036b9a; }
    footer{ height:72px; }
  </style>
</head>
<body>
  <header>
    <div class="title">üõí –ú–∞–≥–∞–∑–∏–Ω</div>
    <div class="muted" id="cart-count">0</div>
  </header>

  <main class="grid" id="grid"></main>
  <footer></footer>

<script>
  const tg = window.Telegram.WebApp;
  // –ü–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Ç–µ–º—É –¢–µ–ª–µ–≥—Ä–∞–º–∞
  if (tg?.colorScheme) {
    const p = tg.themeParams || {};
    const set = (varName, val) => val && document.documentElement.style.setProperty(varName, val);
    set('--bg', p.bg_color);
    set('--text', p.text_color);
    set('--card', p.secondary_bg_color);
    set('--accent', p.button_color);
    set('--muted', p.hint_color);
  }
  tg?.expand();

  // –¢–æ–≤–∞—Ä—ã (–ø—Ä–∏–º–µ—Ä). –ú–æ–∂–µ—à—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Å–≤–æ–∏–º
  const products = [
    {id:1, title:"–§—É—Ç–±–æ–ª–∫–∞ 'Classic'", price:990, img:"https://images.unsplash.com/photo-1520975916090-3105956dac38?q=80&w=1200&auto=format&fit=crop"},
    {id:2, title:"–ö–µ–ø–∫–∞ 'Logo'", price:690, img:"https://images.unsplash.com/photo-1516478177764-9fe5bd7e9717?q=80&w=1200&auto=format&fit=crop"},
    {id:3, title:"–•—É–¥–∏ 'Warm'", price:1990, img:"https://images.unsplash.com/photo-1544025162-d76694265947?q=80&w=1200&auto=format&fit=crop"},
    {id:4, title:"–ù–∞–∫–ª–µ–π–∫–∏ (–ø–∞–∫)", price:250, img:"https://images.unsplash.com/photo-1531297484001-80022131f5a1?q=80&w=1200&auto=format&fit=crop"}
  ];

  const cart = new Map();

  const grid = document.getElementById('grid');
  const cartCount = document.getElementById('cart-count');

  function formatMoney(n){ return n.toLocaleString('ru-RU') + " ‚ÇΩ"; }

  function updateMainButton(){
    let totalQty = 0, total = 0;
    for (const [id, qty] of cart.entries()){
      const p = products.find(x=>x.id===id);
      totalQty += qty; total += p.price * qty;
    }
    cartCount.textContent = totalQty;

    if (totalQty > 0){
      tg.MainButton.setText(`–û—Ñ–æ—Ä–º–∏—Ç—å: ${totalQty} ¬∑ ${formatMoney(total)}`);
      tg.MainButton.show();
    } else {
      tg.MainButton.hide();
    }
  }

  function addToCart(id){
    const qty = cart.get(id) || 0;
    cart.set(id, qty+1);
    updateMainButton();
    render();
  }
  function decFromCart(id){
    const qty = cart.get(id) || 0;
    if (qty > 1){ cart.set(id, qty-1); }
    else { cart.delete(id); }
    updateMainButton();
    render();
  }

  function render(){
    grid.innerHTML = '';
    for (const p of products){
      const qty = cart.get(p.id) || 0;
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <img src="${p.img}" alt="${p.title}">
        <div class="pad">
          <div class="name">${p.title}</div>
          <div class="row">
            <div class="price">${formatMoney(p.price)}</div>
            ${qty === 0 ?
              `<button class="btn" data-add="${p.id}">–í –∫–æ—Ä–∑–∏–Ω—É</button>` :
              `<div class="qty">
                 <button class="btn-ghost" data-dec="${p.id}">‚àí</button>
                 <div><b>${qty}</b></div>
                 <button class="btn-ghost" data-add="${p.id}">+</button>
               </div>`
            }
          </div>
        </div>`;
      grid.appendChild(div);
    }
  }

  grid.addEventListener('click', (e)=>{
    const add = e.target.getAttribute('data-add');
    const dec = e.target.getAttribute('data-dec');
    if (add) addToCart(+add);
    if (dec) decFromCart(+dec);
  });

  tg.MainButton.onClick(()=>{
    let totalQty = 0, total = 0, items = [];
    for (const [id, qty] of cart.entries()){
      const p = products.find(x=>x.id===id);
      totalQty += qty; total += p.price * qty;
      items.push({id, title:p.title, price:p.price, qty, sum: p.price*qty});
    }
    const payload = {items, totalQty, total};
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç–∞
    tg.sendData(JSON.stringify(payload));
    tg.close();
  });

  render();
  updateMainButton();
</script>
</body>
</html>
